<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon.ico">
    <title>Doowon Portal - ì£¼ê°„ë³´ê³ ê´€ë¦¬</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/darkmode.css" />
    <link rel="stylesheet" type="text/css" href="css/table.css" />
</head>

<body>
    <header class="header">
        <div class="logo"><a href="http://211.238.111.33:8080/cb/"><img src="images/doowon_logo.png" alt="Logo" /></a></div>

        <div class="menu-container">
            <span class="menu-item"><img src="images/user.svg" alt="User" /><%= username %></span>
            <a href="#" class="menu-item" onclick="handleLogout()"><img src="images/logout.svg" alt="Logout" />Logout</a>
        </div>                  
    </header>

    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-item <%= currentPath === '/' ? 'active' : '' %>">
                <img src="images/home.svg" alt="Home" />
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/weekly-reports" class="nav-item <%= currentPath === '/weekly-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Weekly Reports" />
                <span>ì£¼ê°„ë³´ê³ ê´€ë¦¬</span>
            </a>
            <a href="/travel-reports" class="nav-item <%= currentPath === '/travel-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Travel Reports" />
                <span>ì¶œì¥ë³´ê³ ê´€ë¦¬</span>
            </a>
            <a href="/hardware-management" class="nav-item <%= currentPath === '/hardware-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Hardware Management" />
                <span>HW/SW ë²„ì „ê´€ë¦¬</span>
            </a>
            <a href="/equipment-management" class="nav-item <%= currentPath === '/equipment-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Equipment Management" />
                <span>ì¥ë¹„ê´€ë¦¬</span>
            </a>
            <a href="/external-training" class="nav-item <%= currentPath === '/external-training' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="External Training" />
                <span>ì™¸ë¶€êµìœ¡ê´€ë¦¬</span>
            </a>
        </div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">â˜°</button>
        <div class="mobile-nav" id="mobileNav">
            <a href="/" class="nav-item <%= currentPath === '/' ? 'active' : '' %>">
                <img src="images/home.svg" alt="Home" />
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/weekly-reports" class="nav-item <%= currentPath === '/weekly-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Weekly Reports" />
                <span>ì£¼ê°„ë³´ê³ ê´€ë¦¬</span>
            </a>
            <a href="/travel-reports" class="nav-item <%= currentPath === '/travel-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Travel Reports" />
                <span>ì¶œì¥ë³´ê³ ê´€ë¦¬</span>
            </a>
            <a href="/hardware-management" class="nav-item <%= currentPath === '/hardware-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Hardware Management" />
                <span>HW/SW ë²„ì „ê´€ë¦¬</span>
            </a>
            <a href="/equipment-management" class="nav-item <%= currentPath === '/equipment-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Equipment Management" />
                <span>ì¥ë¹„ê´€ë¦¬</span>
            </a>
            <a href="/external-training" class="nav-item <%= currentPath === '/external-training' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="External Training" />
                <span>ì™¸ë¶€êµìœ¡ê´€ë¦¬</span>
            </a>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h2>ğŸ“Š ì£¼ê°„ë³´ê³ ê´€ë¦¬</h2>
            <p>ì£¼ê°„ ë³´ê³ ì„œë¥¼ ì‘ì„±, ì œì¶œ ë° ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h3>ìƒˆ ì£¼ê°„ë³´ê³  ì‘ì„±</h3>
                <button class="btn-primary" onclick="showCreateForm()">+ ìƒˆ ë³´ê³ ì„œ ì‘ì„±</button>
            </div>

            <div class="create-form" id="createForm" style="display: none;">
                <div class="dynamic-form-container">
                    <div id="dynamicForm" class="loading">
                        <i>â³</i>
                        <p>í•„ë“œ êµ¬ì„±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                    
                    <div id="validationErrors" class="validation-errors">
                        <h5>ì…ë ¥ ì˜¤ë¥˜:</h5>
                        <ul id="errorList"></ul>
                    </div>
                    
                    <!-- Attachment Field -->
                    <div class="field-group">
                        <h4>ì²¨ë¶€íŒŒì¼</h4>
                        <div class="field-item">
                            <span class="field-label">ì²¨ë¶€íŒŒì¼</span>
                            <div class="field-input-container">
                                <input type="file" id="weeklyAttachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif" class="field-input">
                                <small class="field-help">PDF, DOC, XLS, ì´ë¯¸ì§€ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="hideCreateForm()">ì·¨ì†Œ</button>
                        <button type="button" class="btn-primary" onclick="submitWeeklyReportForm()">ë³´ê³ ì„œ ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section mobile-hide">
            <div class="section-header">
                <h3>ì£¼ê°„ë³´ê³  ëª©ë¡</h3>
                <div class="filter-controls">
                    <select id="statusFilter" onchange="filterReports()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="draft">ì„ì‹œì €ì¥</option>
                        <option value="submitted">ì œì¶œë¨</option>
                        <option value="approved">ìŠ¹ì¸ë¨</option>
                        <option value="rejected">ë°˜ë ¤ë¨</option>
                    </select>
                    <input type="month" id="monthFilter" onchange="filterReports()" placeholder="ì›”ë³„ í•„í„°">
                </div>
            </div>

            <div class="reports-list" id="reportsList">
                <div class="loading" id="loadingIndicator" style="display: none;">
                    <p>ì£¼ê°„ë³´ê³  ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <p>ë“±ë¡ëœ ì£¼ê°„ë³´ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Forms Script -->
    <script src="/js/dynamic-forms.js"></script>
    
    <script>
        let formHandler = new DynamicFormHandler();

        function handleLogout() {
            fetch('/logout', { method: 'GET' })
                .then(() => window.location.href = '/login')
                .catch(error => console.error('Logout error:', error));
        }

        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobileNav');
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            
            if (mobileNav && mobileMenuToggle && 
                !mobileNav.contains(event.target) && 
                !mobileMenuToggle.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        async function showCreateForm() {
            document.getElementById('createForm').style.display = 'block';
            await loadDynamicForm();
        }

        function hideCreateForm() {
            document.getElementById('createForm').style.display = 'none';
            formHandler.clearForm();
            hideValidationErrors();
        }

        // Load dynamic form
        async function loadDynamicForm() {
            try {
                await formHandler.renderForm('dynamicForm', 'weekly-reports');
                console.log('Dynamic form loaded successfully');
            } catch (error) {
                console.error('Error loading dynamic form:', error);
                document.getElementById('dynamicForm').innerHTML = 
                    '<div class="empty-state"><i>âŒ</i><p>í•„ë“œ êµ¬ì„±ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        // Submit weekly report form
        async function submitWeeklyReportForm() {
            const validation = formHandler.validateForm();
            
            if (!validation.isValid) {
                showValidationErrors(validation.errors);
                return;
            }

            const formData = formHandler.getFormData();
            console.log('Submitting weekly report form data:', formData);
            
            try {
                // Get tracker ID from admin configuration or use a default
                const trackerId = await getTrackerIdForSection('weekly-reports');
                if (!trackerId) {
                    alert('ì£¼ê°„ë³´ê³  ê´€ë¦¬ìš© íŠ¸ë˜ì»¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                    return;
                }

                // Transform form data for CodeBeamer API
                const codebeamerData = transformFormDataForCodeBeamer(formData, 'weekly-reports', trackerId);
                console.log('Transformed data for CodeBeamer:', codebeamerData);

                const response = await fetch(`/api/v33/trackers/${trackerId}/items`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(codebeamerData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ì£¼ê°„ë³´ê³ ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    hideCreateForm();
                } else {
                    alert('ì£¼ê°„ë³´ê³  ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                console.error('Error submitting weekly report form:', error);
                alert('ì£¼ê°„ë³´ê³  ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Get tracker ID for a specific section
        async function getTrackerIdForSection(section) {
            try {
                const response = await fetch(`/api/tracker-id/${section}`);
                const data = await response.json();
                
                if (data.success && data.trackerId) {
                    return data.trackerId;
                }
                
                console.warn(`No tracker ID configured for section: ${section}`);
                return null;
            } catch (error) {
                console.error('Error getting tracker ID:', error);
                return null;
            }
        }

        function showValidationErrors(errors) {
            const errorContainer = document.getElementById('validationErrors');
            const errorList = document.getElementById('errorList');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorContainer.classList.add('show');
        }

        function hideValidationErrors() {
            document.getElementById('validationErrors').classList.remove('show');
        }

        function editItem(itemId) {
            console.log('Editing weekly report:', itemId);
        }

        function deleteItem(itemId) {
            console.log('Deleting weekly report:', itemId);
        }

        async function loadWeeklyReports() {
            try {
                const response = await fetch('/api/weekly-reports');
                const data = await response.json();
                
                if (data.success) {
                    const reportsList = document.getElementById('reportsList');
                    if (reportsList) {
                        await formHandler.renderTable('reportsList', data.items, 'weekly-reports');
                    }
                } else {
                    console.error('Failed to load weekly reports:', data.error);
                }
            } catch (error) {
                console.error('Error loading weekly reports:', error);
            }
        }

        function filterReports() {
            const statusFilter = document.getElementById('statusFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            
            console.log('Filtering reports by status:', statusFilter, 'month:', monthFilter);
        }

        function editReport(id) {
            console.log('Editing report:', id);
            showCreateForm();
        }

        function submitReport(id) {
            console.log('Submitting report:', id);
        }

        function deleteReport(id) {
            if (confirm('ì •ë§ë¡œ ì´ ë³´ê³ ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                console.log('Deleting report:', id);
            }
        }

        function viewReport(id) {
            console.log('Viewing report:', id);
        }

        function downloadReport(id) {
            console.log('Downloading report:', id);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }


        document.addEventListener('DOMContentLoaded', function() {
            loadWeeklyReports();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'create') {
                showCreateForm();
            }
        });
    </script>
</body>
</html>
