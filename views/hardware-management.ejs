<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon.ico">
    <title>Doowon Portal - 하드웨어관리</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/darkmode.css" />
 
</head>

<body>
    <header class="header">
        <div class="logo"><a href="http://211.238.111.33:8080/cb/"><img src="images/doowon_logo.png" alt="Logo" /></a></div>
        <div class="title-container"><h1>Doowon Portal</h1><p>두원공조 포탈</p></div>
        <div class="menu-container">
            <span class="menu-item"><img src="images/user.svg" alt="User" /><%= username %></span>
            <a href="#" class="menu-item" onclick="handleLogout()"><img src="images/logout.svg" alt="Logout" />Logout</a>
        </div>                  
    </header>

    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-item <%= currentPath === '/' ? 'active' : '' %>">
                <img src="images/home.svg" alt="Home" />
                <span>대시보드</span>
            </a>
            <a href="/weekly-reports" class="nav-item <%= currentPath === '/weekly-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Weekly Reports" />
                <span>주간보고관리</span>
            </a>
            <a href="/travel-reports" class="nav-item <%= currentPath === '/travel-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Travel Reports" />
                <span>출장보고관리</span>
            </a>
            <a href="/hardware-management" class="nav-item <%= currentPath === '/hardware-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Hardware Management" />
                <span>하드웨어관리</span>
            </a>
            <a href="/equipment-management" class="nav-item <%= currentPath === '/equipment-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Equipment Management" />
                <span>장비관리</span>
            </a>
            <a href="/external-training" class="nav-item <%= currentPath === '/external-training' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="External Training" />
                <span>외부교육관리</span>
            </a>
        </div>
        <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">☰</button>
        <div class="mobile-nav" id="mobileNav">
            <a href="/" class="nav-item <%= currentPath === '/' ? 'active' : '' %>">
                <img src="images/home.svg" alt="Home" />
                <span>대시보드</span>
            </a>
            <a href="/weekly-reports" class="nav-item <%= currentPath === '/weekly-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Weekly Reports" />
                <span>주간보고관리</span>
            </a>
            <a href="/travel-reports" class="nav-item <%= currentPath === '/travel-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Travel Reports" />
                <span>출장보고관리</span>
            </a>
            <a href="/hardware-management" class="nav-item <%= currentPath === '/hardware-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Hardware Management" />
                <span>하드웨어관리</span>
            </a>
            <a href="/equipment-management" class="nav-item <%= currentPath === '/equipment-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Equipment Management" />
                <span>장비관리</span>
            </a>
            <a href="/external-training" class="nav-item <%= currentPath === '/external-training' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="External Training" />
                <span>외부교육관리</span>
            </a>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h2>💻 하드웨어관리</h2>
            <p>하드웨어 자산을 등록, 관리 및 추적할 수 있습니다.</p>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h3>새 하드웨어 등록</h3>
                <button class="btn-primary" onclick="showCreateForm()">+ 새 하드웨어 등록</button>
            </div>

            <div class="create-form" id="createForm" style="display: none;">
                <div class="dynamic-form-container">
                    <div id="dynamicForm" class="loading">
                        <i>⏳</i>
                        <p>필드 구성을 불러오는 중...</p>
                    </div>
                    
                    <div id="validationErrors" class="validation-errors">
                        <h5>입력 오류:</h5>
                        <ul id="errorList"></ul>
                    </div>
                    
                    <!-- Attachment Field -->
                    <div class="field-group">
                        <h4>첨부파일</h4>
                        <div class="field-item">
                            <span class="field-label">첨부파일</span>
                            <div class="field-input-container">
                                <input type="file" id="hardwareAttachments" name="attachments" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif" class="field-input">
                                <small class="field-help">PDF, DOC, XLS, 이미지 파일을 업로드할 수 있습니다.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="hideCreateForm()">취소</button>
                        <button type="button" class="btn-primary" onclick="submitHardwareForm()">하드웨어 등록</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-section mobile-hide">
            <div class="section-header">
                <h3>하드웨어 목록</h3>
                <div class="filter-controls">
                    <select id="vehicleTypeFilter" onchange="filterHardware()">
                        <option value="">전체 차종</option>
                    </select>
                    <select id="changeTypeFilter" onchange="filterHardware()">
                        <option value="">전체 변경사항</option>
                        <option value="H/W">HW</option>
                        <option value="S/W">SW</option>
                    </select>
                    <select id="statusFilter" onchange="filterHardware()">
                        <option value="">전체 상태</option>
                        <option value="ToDo">ToDo</option>
                        <option value="In progress">In progress</option>
                        <option value="To verify">To verify</option>
                        <option value="Done">Done</option>
                    </select>
                    <input type="text" id="searchFilter" onkeyup="filterHardware()" placeholder="하드웨어명, 버전, 차종으로 검색...">
                </div>
            </div>

            <div class="hardware-list" id="hardwareList">
                <div class="loading" id="loadingIndicator" style="display: none;">
                    <p>하드웨어 목록을 불러오는 중...</p>
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <p>등록된 하드웨어가 없습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Forms Script -->
    <script src="/js/dynamic-forms.js"></script>
    
    <script>
        let hardwareItems = [];
        let vehicleTypes = [];
        let formHandler = new DynamicFormHandler();

        // Load vehicle types from API
        async function loadVehicleTypes() {
            try {
                const response = await fetch('/api/vehicle-types');
                const data = await response.json();
                
                if (data.success) {
                    vehicleTypes = data.vehicleTypes;
                    populateVehicleTypeSelects();
                } else {
                    console.error('Failed to load vehicle types:', data.error);
                    // Fallback to default types
                    vehicleTypes = ['SW', 'OV1', 'HE1i', 'SX3', 'NQ6', 'LT2'];
                    populateVehicleTypeSelects();
                }
            } catch (error) {
                console.error('Error loading vehicle types:', error);
                // Fallback to default types
                vehicleTypes = ['SW', 'OV1', 'HE1i', 'SX3', 'NQ6', 'LT2'];
                populateVehicleTypeSelects();
            }
        }

        // Populate vehicle type select elements
        function populateVehicleTypeSelects() {
            const formSelect = document.getElementById('vehicleType');
            const filterSelect = document.getElementById('vehicleTypeFilter');
            
            // Clear existing options (except first option)
            if (formSelect) {
                formSelect.innerHTML = '<option value="">선택하세요</option>';
                vehicleTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    formSelect.appendChild(option);
                });
            }
            
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">전체 차종</option>';
                vehicleTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    filterSelect.appendChild(option);
                });
            }
        }

        function handleLogout() {
            fetch('/logout', { method: 'GET' })
                .then(() => window.location.href = '/login')
                .catch(error => console.error('Logout error:', error));
        }

        function toggleMobileMenu() {
            const mobileNav = document.getElementById('mobileNav');
            mobileNav.classList.toggle('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileNav = document.getElementById('mobileNav');
            const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
            
            if (mobileNav && mobileMenuToggle && 
                !mobileNav.contains(event.target) && 
                !mobileMenuToggle.contains(event.target)) {
                mobileNav.classList.remove('active');
            }
        });

        async function loadHardwareItems() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const emptyState = document.getElementById('emptyState');
            const hardwareList = document.getElementById('hardwareList');
            
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';
            
            try {
                const response = await fetch('/api/hardware');
                const data = await response.json();
                
                if (data.success) {
                    hardwareItems = data.items;
                    await renderHardwareList();
                } else {
                    console.error('Failed to load hardware items:', data.error);
                    showError('하드웨어 목록을 불러오는데 실패했습니다.');
                }
            } catch (error) {
                console.error('Error loading hardware items:', error);
                showError('하드웨어 목록을 불러오는 중 오류가 발생했습니다.');
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }

        async function renderHardwareList() {
            const hardwareList = document.getElementById('hardwareList');
            const emptyState = document.getElementById('emptyState');
            
            if (!hardwareList) return;
            
            if (hardwareItems.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            const filteredItems = filterHardwareItems();
            
            try {
                await formHandler.renderTable('hardwareList', filteredItems, 'hardware-management');
            } catch (error) {
                console.error('Error rendering dynamic table:', error);
                hardwareList.innerHTML = '<div class="empty-state"><i>❌</i><p>테이블을 불러올 수 없습니다.</p></div>';
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'ToDo': return 'inactive';
                case 'In progress': return 'active';
                case 'To verify': return 'warning';
                case 'Done': return 'success';
                default: return 'inactive';
            }
        }

        function filterHardwareItems() {
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const vehicleTypeFilter = document.getElementById('vehicleTypeFilter').value;
            const changeTypeFilter = document.getElementById('changeTypeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            return hardwareItems.filter(item => {
                const matchesSearch = !searchFilter || 
                    item.name.toLowerCase().includes(searchFilter) ||
                    (item.hwVersion && item.hwVersion.toLowerCase().includes(searchFilter)) ||
                    (item.swVersion && item.swVersion.toLowerCase().includes(searchFilter)) ||
                    (item.vehicleType && item.vehicleType.toLowerCase().includes(searchFilter)) ||
                    (item.changeReason && item.changeReason.toLowerCase().includes(searchFilter));
                
                const matchesVehicleType = !vehicleTypeFilter || item.vehicleType === vehicleTypeFilter;
                const matchesChangeType = !changeTypeFilter || item.changeType === changeTypeFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                
                return matchesSearch && matchesVehicleType && matchesChangeType && matchesStatus;
            });
        }

        async function showCreateForm() {
            document.getElementById('createForm').style.display = 'block';
            await loadDynamicForm();
        }

        function hideCreateForm() {
            document.getElementById('createForm').style.display = 'none';
            formHandler.clearForm();
            hideValidationErrors();
        }

        // Load dynamic form
        async function loadDynamicForm() {
            try {
                await formHandler.renderForm('dynamicForm', 'hardware-management');
                console.log('Dynamic form loaded successfully');
            } catch (error) {
                console.error('Error loading dynamic form:', error);
                document.getElementById('dynamicForm').innerHTML = 
                    '<div class="empty-state"><i>❌</i><p>필드 구성을 불러올 수 없습니다.</p></div>';
            }
        }

        // Submit hardware form
        async function submitHardwareForm() {
            const validation = formHandler.validateForm();
            
            if (!validation.isValid) {
                showValidationErrors(validation.errors);
                return;
            }

            const formData = formHandler.getFormData();
            console.log('Submitting hardware form data:', formData);
            
            try {
                const response = await fetch('/api/hardware', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('하드웨어가 등록되었습니다!');
                    hideCreateForm();
                    loadHardwareItems();
                } else {
                    alert('하드웨어 등록에 실패했습니다: ' + data.error);
                }
            } catch (error) {
                console.error('Error submitting hardware form:', error);
                alert('하드웨어 등록 중 오류가 발생했습니다.');
            }
        }

        // Show validation errors
        function showValidationErrors(errors) {
            const errorContainer = document.getElementById('validationErrors');
            const errorList = document.getElementById('errorList');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorContainer.classList.add('show');
        }

        // Hide validation errors
        function hideValidationErrors() {
            document.getElementById('validationErrors').classList.remove('show');
        }

        // Edit item function for dynamic table
        function editItem(itemId) {
            const item = hardwareItems.find(h => h.id === itemId);
            if (item) {
                showCreateForm();
                formHandler.setFormData(item);
            }
        }

        // Delete item function for dynamic table
        function deleteItem(itemId) {
            deleteHardware(itemId);
        }

        function filterHardware() {
            renderHardwareList();
        }

        // Note: CodeBeamer does not support updating items, only creating and deleting

        function viewHardware(id) {
            const item = hardwareItems.find(h => h.id === id);
            if (!item) return;
            
            alert(`하드웨어 상세정보:\n\n이름: ${item.name}\nH/W 버전: ${item.hwVersion || 'N/A'}\nS/W 버전: ${item.swVersion || 'N/A'}\n차종: ${item.vehicleType || 'N/A'}\n변경사항: ${item.changeType || 'N/A'}\n변경 사유: ${item.changeReason || 'N/A'}\nRelease 일자: ${item.releaseDate || 'N/A'}\n상태: ${item.status}\n설명: ${item.description || 'N/A'}`);
        }

        async function deleteHardware(id) {
            if (!confirm('정말로 이 하드웨어를 삭제하시겠습니까?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hardware/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('하드웨어가 삭제되었습니다.');
                    loadHardwareItems();
                } else {
                    showError('하드웨어 삭제에 실패했습니다: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting hardware:', error);
                showError('하드웨어 삭제 중 오류가 발생했습니다.');
            }
        }

        async function saveHardware(formData) {
            try {
                const response = await fetch('/api/hardware', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('하드웨어가 등록되었습니다.');
                    hideCreateForm();
                    loadHardwareItems();
                } else {
                    showError('저장에 실패했습니다: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving hardware:', error);
                showError('저장 중 오류가 발생했습니다.');
            }
        }

        function showSuccess(message) {
            alert('성공: ' + message);
        }

        function showError(message) {
            alert('오류: ' + message);
        }



        document.addEventListener('DOMContentLoaded', function() {
            loadVehicleTypes();
            loadHardwareItems();
            
            // Check if we should show create form
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'create') {
                showCreateForm();
            }
        });
    </script>
</body>
</html>
