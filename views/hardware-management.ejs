<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon.ico">
    <title>Doowon Portal - í•˜ë“œì›¨ì–´ê´€ë¦¬</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/darkmode.css" />
    <style>
        .hardware-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .hardware-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
        }
        
        .hardware-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .hardware-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.status-inactive {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .status-badge.status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-badge.status-success {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .btn-small {
            padding: 4px 8px;
            margin: 2px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="logo"><a href="http://211.238.111.33:8080/cb/"><img src="images/doowon_logo.png" alt="Logo" /></a></div>
        <div class="title-container"><h1>Doowon Portal</h1><p>ë‘ì›ê³µì¡° í¬íƒˆ</p></div>
        <div class="menu-container">
            <span class="menu-item"><img src="images/user.svg" alt="User" /><%= username %></span>
            <a href="#" class="menu-item" onclick="handleLogout()"><img src="images/logout.svg" alt="Logout" />Logout</a>
        </div>                  
    </header>

    <nav class="main-nav">
        <div class="nav-container">
            <a href="/" class="nav-item <%= currentPath === '/' ? 'active' : '' %>">
                <img src="images/home.svg" alt="Home" />
                <span>ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/weekly-reports" class="nav-item <%= currentPath === '/weekly-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Weekly Reports" />
                <span>ì£¼ê°„ë³´ê³ ê´€ë¦¬</span>
            </a>
            <a href="/travel-reports" class="nav-item <%= currentPath === '/travel-reports' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Travel Reports" />
                <span>ì¶œì¥ë³´ê³ ê´€ë¦¬</span>
            </a>
            <a href="/hardware-management" class="nav-item <%= currentPath === '/hardware-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Hardware Management" />
                <span>í•˜ë“œì›¨ì–´ê´€ë¦¬</span>
            </a>
            <a href="/equipment-management" class="nav-item <%= currentPath === '/equipment-management' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="Equipment Management" />
                <span>ì¥ë¹„ê´€ë¦¬</span>
            </a>
            <a href="/external-training" class="nav-item <%= currentPath === '/external-training' ? 'active' : '' %>">
                <img src="images/settings.svg" alt="External Training" />
                <span>ì™¸ë¶€êµìœ¡ê´€ë¦¬</span>
            </a>
        </div>
    </nav>

    <div class="main-container">
        <div class="page-header">
            <h2>ğŸ’» í•˜ë“œì›¨ì–´ê´€ë¦¬</h2>
            <p>í•˜ë“œì›¨ì–´ ìì‚°ì„ ë“±ë¡, ê´€ë¦¬ ë° ì¶”ì í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h3>ìƒˆ í•˜ë“œì›¨ì–´ ë“±ë¡</h3>
                <button class="btn-primary" onclick="showCreateForm()">+ ìƒˆ í•˜ë“œì›¨ì–´ ë“±ë¡</button>
            </div>

            <div class="create-form" id="createForm" style="display: none;">
                <form id="hardwareForm">
                    <input type="hidden" id="hardwareId" name="id">
                    
                    <div class="form-group">
                        <label for="hardwareName">í•˜ë“œì›¨ì–´ëª… (HW ë²„ì „ê³¼ ë™ì¼)</label>
                        <input type="text" id="hardwareName" name="name" readonly placeholder="HW ë²„ì „ì„ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="hwVersion">HW ë²„ì „ *</label>
                            <input type="text" id="hwVersion" name="hwVersion" required placeholder="í•˜ë“œì›¨ì–´ ë²„ì „ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group">
                            <label for="swVersion">SW ë²„ì „</label>
                            <input type="text" id="swVersion" name="swVersion" placeholder="ì†Œí”„íŠ¸ì›¨ì–´ ë²„ì „ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="vehicleType">ì°¨ì¢…</label>
                            <select id="vehicleType" name="vehicleType">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="SW">SW</option>
                                <option value="OV1">OV1</option>
                                <option value="HE1i">HE1i</option>
                                <option value="SX3">SX3</option>
                                <option value="NQ6">NQ6</option>
                                <option value="LT2">LT2</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="changeType">ë³€ê²½ì‚¬í•­</label>
                            <select id="changeType" name="changeType">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                <option value="H/W">HW</option>
                                <option value="S/W">SW</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="changeReason">ë³€ê²½ ì‚¬ìœ  *</label>
                            <input type="text" id="changeReason" name="changeReason" required placeholder="ë³€ê²½ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group">
                            <label for="releaseDate">Release ì¼ì</label>
                            <input type="date" id="releaseDate" name="releaseDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">ì„¤ëª… *</label>
                        <textarea id="description" name="description" rows="4" required placeholder="í•˜ë“œì›¨ì–´ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="hideCreateForm()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn-primary" id="submitButton">í•˜ë“œì›¨ì–´ ë“±ë¡</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="content-section">
            <div class="section-header">
                <h3>í•˜ë“œì›¨ì–´ ëª©ë¡</h3>
                <div class="filter-controls">
                    <select id="vehicleTypeFilter" onchange="filterHardware()">
                        <option value="">ì „ì²´ ì°¨ì¢…</option>
                        <option value="SW">SW</option>
                        <option value="OV1">OV1</option>
                        <option value="HE1i">HE1i</option>
                        <option value="SX3">SX3</option>
                        <option value="NQ6">NQ6</option>
                        <option value="LT2">LT2</option>
                    </select>
                    <select id="changeTypeFilter" onchange="filterHardware()">
                        <option value="">ì „ì²´ ë³€ê²½ì‚¬í•­</option>
                        <option value="H/W">HW</option>
                        <option value="S/W">SW</option>
                    </select>
                    <select id="statusFilter" onchange="filterHardware()">
                        <option value="">ì „ì²´ ìƒíƒœ</option>
                        <option value="ToDo">ToDo</option>
                        <option value="In progress">In progress</option>
                        <option value="To verify">To verify</option>
                        <option value="Done">Done</option>
                    </select>
                    <input type="text" id="searchFilter" onkeyup="filterHardware()" placeholder="í•˜ë“œì›¨ì–´ëª…, ë²„ì „, ì°¨ì¢…ìœ¼ë¡œ ê²€ìƒ‰...">
                </div>
            </div>

            <div class="hardware-list" id="hardwareList">
                <div class="loading" id="loadingIndicator" style="display: none;">
                    <p>í•˜ë“œì›¨ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
                <div class="empty-state" id="emptyState" style="display: none;">
                    <p>ë“±ë¡ëœ í•˜ë“œì›¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let hardwareItems = [];

        function handleLogout() {
            fetch('/logout', { method: 'GET' })
                .then(() => window.location.href = '/login')
                .catch(error => console.error('Logout error:', error));
        }

        async function loadHardwareItems() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const emptyState = document.getElementById('emptyState');
            const hardwareList = document.getElementById('hardwareList');
            
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (emptyState) emptyState.style.display = 'none';
            
            try {
                const response = await fetch('/api/hardware');
                const data = await response.json();
                
                if (data.success) {
                    hardwareItems = data.items;
                    renderHardwareList();
                } else {
                    console.error('Failed to load hardware items:', data.error);
                    showError('í•˜ë“œì›¨ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error loading hardware items:', error);
                showError('í•˜ë“œì›¨ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                if (loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }

        function renderHardwareList() {
            const hardwareList = document.getElementById('hardwareList');
            const emptyState = document.getElementById('emptyState');
            
            if (!hardwareList) return;
            
            if (hardwareItems.length === 0) {
                if (emptyState) emptyState.style.display = 'block';
                return;
            }
            
            if (emptyState) emptyState.style.display = 'none';
            
            const filteredItems = filterHardwareItems();
            
            hardwareList.innerHTML = `
                <table class="hardware-table">
                    <thead>
                        <tr>
                            <th>í•˜ë“œì›¨ì–´ëª…</th>
                            <th>ìƒíƒœ</th>
                            <th>HW ë²„ì „</th>
                            <th>SW ë²„ì „</th>
                            <th>ì°¨ì¢…</th>
                            <th>ë³€ê²½ì‚¬í•­</th>
                            <th>ë³€ê²½ ì‚¬ìœ </th>
                            <th>Release ì¼ì</th>
                            <th>ë“±ë¡ì</th>
                            <th>ìˆ˜ì •ì¼</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredItems.map(item => `
                            <tr>
                                <td><strong>${item.name}</strong></td>
                                <td><span class="status-badge status-${getStatusClass(item.status)}">${item.status}</span></td>
                                <td>${item.hwVersion || 'N/A'}</td>
                                <td>${item.swVersion || 'N/A'}</td>
                                <td>${item.vehicleType || 'N/A'}</td>
                                <td>${item.changeType || 'N/A'}</td>
                                <td>${item.changeReason || 'N/A'}</td>
                                <td>${item.releaseDate || 'N/A'}</td>
                                <td>${item.submittedBy || 'N/A'}</td>
                                <td>${item.modifiedAt ? new Date(item.modifiedAt).toLocaleDateString() : 'N/A'}</td>
                                <td>
                                    <button class="btn-small btn-info" onclick="viewHardware(${item.id})">ìƒì„¸ë³´ê¸°</button>
                                    <button class="btn-small btn-danger" onclick="deleteHardware(${item.id})">ì‚­ì œ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function getStatusClass(status) {
            switch(status) {
                case 'ToDo': return 'inactive';
                case 'In progress': return 'active';
                case 'To verify': return 'warning';
                case 'Done': return 'success';
                default: return 'inactive';
            }
        }

        function filterHardwareItems() {
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const vehicleTypeFilter = document.getElementById('vehicleTypeFilter').value;
            const changeTypeFilter = document.getElementById('changeTypeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            return hardwareItems.filter(item => {
                const matchesSearch = !searchFilter || 
                    item.name.toLowerCase().includes(searchFilter) ||
                    (item.hwVersion && item.hwVersion.toLowerCase().includes(searchFilter)) ||
                    (item.swVersion && item.swVersion.toLowerCase().includes(searchFilter)) ||
                    (item.vehicleType && item.vehicleType.toLowerCase().includes(searchFilter)) ||
                    (item.changeReason && item.changeReason.toLowerCase().includes(searchFilter));
                
                const matchesVehicleType = !vehicleTypeFilter || item.vehicleType === vehicleTypeFilter;
                const matchesChangeType = !changeTypeFilter || item.changeType === changeTypeFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                
                return matchesSearch && matchesVehicleType && matchesChangeType && matchesStatus;
            });
        }

        function showCreateForm() {
            document.getElementById('createForm').style.display = 'block';
            document.getElementById('hardwareForm').reset();
            document.getElementById('submitButton').textContent = 'í•˜ë“œì›¨ì–´ ë“±ë¡';
        }

        function hideCreateForm() {
            document.getElementById('createForm').style.display = 'none';
            document.getElementById('hardwareForm').reset();
        }

        function filterHardware() {
            renderHardwareList();
        }

        // Note: CodeBeamer does not support updating items, only creating and deleting

        function viewHardware(id) {
            const item = hardwareItems.find(h => h.id === id);
            if (!item) return;
            
            alert(`í•˜ë“œì›¨ì–´ ìƒì„¸ì •ë³´:\n\nì´ë¦„: ${item.name}\nH/W ë²„ì „: ${item.hwVersion || 'N/A'}\nS/W ë²„ì „: ${item.swVersion || 'N/A'}\nì°¨ì¢…: ${item.vehicleType || 'N/A'}\në³€ê²½ì‚¬í•­: ${item.changeType || 'N/A'}\në³€ê²½ ì‚¬ìœ : ${item.changeReason || 'N/A'}\nRelease ì¼ì: ${item.releaseDate || 'N/A'}\nìƒíƒœ: ${item.status}\nì„¤ëª…: ${item.description || 'N/A'}`);
        }

        async function deleteHardware(id) {
            if (!confirm('ì •ë§ë¡œ ì´ í•˜ë“œì›¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/hardware/${id}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('í•˜ë“œì›¨ì–´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadHardwareItems();
                } else {
                    showError('í•˜ë“œì›¨ì–´ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                console.error('Error deleting hardware:', error);
                showError('í•˜ë“œì›¨ì–´ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function saveHardware(formData) {
            try {
                const response = await fetch('/api/hardware', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('í•˜ë“œì›¨ì–´ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    hideCreateForm();
                    loadHardwareItems();
                } else {
                    showError('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + data.error);
                }
            } catch (error) {
                console.error('Error saving hardware:', error);
                showError('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function showSuccess(message) {
            alert('ì„±ê³µ: ' + message);
        }

        function showError(message) {
            alert('ì˜¤ë¥˜: ' + message);
        }

        document.getElementById('hardwareForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('hardwareName').value,
                description: document.getElementById('description').value,
                hwVersion: document.getElementById('hwVersion').value,
                swVersion: document.getElementById('swVersion').value,
                vehicleType: document.getElementById('vehicleType').value,
                changeType: document.getElementById('changeType').value,
                changeReason: document.getElementById('changeReason').value,
                releaseDate: document.getElementById('releaseDate').value
            };
            
            if (!formData.hwVersion || !formData.description || !formData.changeReason) {
                showError('H/W ë²„ì „, ì„¤ëª…, ë³€ê²½ ì‚¬ìœ ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }
            
            // Set hardware name to H/W version
            formData.name = formData.hwVersion;
            
            saveHardware(formData);
        });

        // Auto-update hardware name when H/W version changes
        document.getElementById('hwVersion').addEventListener('input', function() {
            document.getElementById('hardwareName').value = this.value;
        });

        document.addEventListener('DOMContentLoaded', function() {
            loadHardwareItems();
            
            // Check if we should show create form
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'create') {
                showCreateForm();
            }
        });
    </script>
</body>
</html>
