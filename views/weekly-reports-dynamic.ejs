<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/favicon.ico">
    <title>Doowon Portal - ì£¼ê°„ë³´ê³ ê´€ë¦¬ (Dynamic)</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/darkmode.css" />
    <link rel="stylesheet" type="text/css" href="css/table.css" />
</head>

<body>
    <div class="portal-header">
        <h1>ğŸ“Š ì£¼ê°„ë³´ê³ ê´€ë¦¬ (Dynamic)</h1>
        <p>ë™ì  í•„ë“œ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•œ ì£¼ê°„ë³´ê³ ì„œ ê´€ë¦¬</p>
    </div>

    <nav class="portal-nav">
        <div class="portal-nav-container">
            <div class="portal-nav-title">ë‘ì›ê³µì¡° í¬íƒˆ</div>
            <div class="portal-nav-actions">
                <span class="portal-username">ì‚¬ìš©ì: <%= username %></span>
                <a href="/logout" class="btn-portal btn-secondary">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </nav>

    <div class="portal-section">
        <!-- ìƒˆ ë³´ê³ ì„œ ì‘ì„± -->
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ“ ìƒˆ ì£¼ê°„ë³´ê³ ì„œ ì‘ì„±</h3>
                <p>ë™ì ìœ¼ë¡œ êµ¬ì„±ëœ í•„ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ê°„ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="section-content">
                <div class="dynamic-form-container">
                    <div id="dynamicForm" class="loading">
                        <i>â³</i>
                        <p>í•„ë“œ êµ¬ì„±ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                    
                    <div id="validationErrors" class="validation-errors">
                        <h5>ì…ë ¥ ì˜¤ë¥˜:</h5>
                        <ul id="errorList"></ul>
                    </div>
                    
                    <div class="form-actions">
                        <button class="btn-portal btn-primary" onclick="submitForm()">ë³´ê³ ì„œ ì œì¶œ</button>
                        <button class="btn-portal btn-secondary" onclick="clearForm()">ì´ˆê¸°í™”</button>
                        <button class="btn-portal btn-info" onclick="previewForm()">ë¯¸ë¦¬ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë³´ê³ ì„œ ëª©ë¡ -->
        <div class="section-card">
            <div class="section-header">
                <h3>ğŸ“‹ ì£¼ê°„ë³´ê³ ì„œ ëª©ë¡</h3>
                <p>ì œì¶œëœ ì£¼ê°„ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            </div>
            <div class="section-content">
                <div id="dynamicTable" class="loading">
                    <i>â³</i>
                    <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Forms Script -->
    <script src="/js/dynamic-forms.js"></script>
    
    <script>
        let currentFormData = {};
        let mockReports = [
            {
                id: 1,
                name: "2024ë…„ 1ì›” 1ì£¼ì°¨ ì£¼ê°„ë³´ê³ ",
                custom_field_1: "1ì£¼ì°¨",
                submittedAt: "2024-01-08",
                custom_field_2: "ê°œë°œíŒ€",
                custom_field_3: "ì£¼ê°„ ì—…ë¬´ ì§„í–‰ ìƒí™© ë³´ê³ ",
                custom_field_4: "ë‹¤ìŒ ì£¼ ê³„íš ìˆ˜ë¦½",
                attachments: "report_20240108.pdf",
                status: "ì™„ë£Œ"
            },
            {
                id: 2,
                name: "2024ë…„ 1ì›” 2ì£¼ì°¨ ì£¼ê°„ë³´ê³ ",
                custom_field_1: "2ì£¼ì°¨",
                submittedAt: "2024-01-15",
                custom_field_2: "ê°œë°œíŒ€",
                custom_field_3: "í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™© ë° ì´ìŠˆ ë³´ê³ ",
                custom_field_4: "ì´ìŠˆ í•´ê²° ë° ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰",
                attachments: "report_20240115.pdf",
                status: "ê²€í† ì¤‘"
            }
        ];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadDynamicForm();
            loadDynamicTable();
        });

        // Initialize dynamic form handler
        const formHandler = new DynamicFormHandler();

        // Load dynamic form
        async function loadDynamicForm() {
            try {
                await formHandler.renderForm('dynamicForm', 'weekly-reports');
                console.log('Dynamic form loaded successfully');
            } catch (error) {
                console.error('Error loading dynamic form:', error);
                document.getElementById('dynamicForm').innerHTML = 
                    '<div class="empty-state"><i>âŒ</i><p>í•„ë“œ êµ¬ì„±ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        // Load dynamic table
        async function loadDynamicTable() {
            try {
                await formHandler.renderTable('dynamicTable', mockReports, 'weekly-reports');
                console.log('Dynamic table loaded successfully');
            } catch (error) {
                console.error('Error loading dynamic table:', error);
                document.getElementById('dynamicTable').innerHTML = 
                    '<div class="empty-state"><i>âŒ</i><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p></div>';
            }
        }

        // Submit form
        function submitForm() {
            const validation = validateForm();
            
            if (!validation.isValid) {
                showValidationErrors(validation.errors);
                return;
            }

            const formData = getFormData();
            console.log('Submitting form data:', formData);
            
            // Here you would typically send the data to the server
            alert('ë³´ê³ ì„œê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // Add to mock data
            const newReport = {
                id: mockReports.length + 1,
                ...formData,
                submittedAt: new Date().toISOString().split('T')[0],
                status: 'ëŒ€ê¸°ì¤‘'
            };
            mockReports.unshift(newReport);
            
            // Reload table
            loadDynamicTable();
            
            // Clear form
            clearForm();
            hideValidationErrors();
        }

        // Clear form
        function clearForm() {
            clearForm();
            hideValidationErrors();
        }

        // Preview form
        function previewForm() {
            const formData = getFormData();
            console.log('Form preview data:', formData);
            alert('ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
        }

        // Show validation errors
        function showValidationErrors(errors) {
            const errorContainer = document.getElementById('validationErrors');
            const errorList = document.getElementById('errorList');
            
            errorList.innerHTML = '';
            errors.forEach(error => {
                const li = document.createElement('li');
                li.textContent = error;
                errorList.appendChild(li);
            });
            
            errorContainer.classList.add('show');
        }

        // Hide validation errors
        function hideValidationErrors() {
            document.getElementById('validationErrors').classList.remove('show');
        }

        // Edit item
        function editItem(itemId) {
            const item = mockReports.find(report => report.id === itemId);
            if (item) {
                setFormData(item);
                document.getElementById('dynamicForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Delete item
        function deleteItem(itemId) {
            if (confirm('ì´ ë³´ê³ ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                mockReports = mockReports.filter(report => report.id !== itemId);
                loadDynamicTable();
            }
        }
    </script>
</body>
</html>
